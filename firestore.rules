rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user owns the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // ========== APP STATS ==========
    // Public stats for displaying on homepage
    match /app_stats/{docId} {
      // Anyone can read stats (for homepage display)
      allow read: if true;

      // Anyone can increment downloads count (users can download without login)
      allow update: if request.resource.data.diff(resource.data).affectedKeys()
                       .hasOnly(['downloadsCount', 'lastUpdated']);

      // Only authenticated users can increment users count (requires signup)
      allow update: if isAuthenticated()
                    && request.resource.data.diff(resource.data).affectedKeys()
                       .hasOnly(['usersCount', 'lastUpdated']);

      // Only allow creation if authenticated (initialization)
      allow create: if isAuthenticated();
    }

    // ========== USER DATA ==========
    match /users/{userId} {
      // Users can read and write their own profile
      allow read, write: if isOwner(userId);

      // Resumes subcollection - user's private resumes
      match /resumes/{resumeId} {
        // Users can read/write their own resumes
        allow read, write: if isOwner(userId);

        // Allow public read if resume is marked public
        allow read: if resource.data.isPublic == true;
      }

      // Preferences subcollection (favorites, settings)
      match /preferences/{docId} {
        allow read, write: if isOwner(userId);
      }
    }

    // ========== PUBLIC RESUMES ==========
    match /publicResumes/{resumeId} {
      // Anyone can read public resumes
      allow read: if true;

      // Only the author can create/update their own public resumes
      allow create: if isAuthenticated()
                    && request.resource.data.authorId == request.auth.uid;

      allow update: if isAuthenticated()
                    && resource.data.authorId == request.auth.uid;

      // Only the author can delete
      allow delete: if isAuthenticated()
                    && resource.data.authorId == request.auth.uid;

      // Allow anyone to increment view counter (specific field only)
      allow update: if request.resource.data.diff(resource.data).affectedKeys().hasOnly(['views'])
                    && request.resource.data.views == resource.data.views + 1;
    }

    // ========== RESUME VERSION HISTORY ==========
    // Version history is tied to user's resumes
    match /resumeVersions/{resumeId}/versions/{versionId} {
      // Users can only access versions for their own resumes
      // The resumeId should match a resume owned by the user
      allow read: if isAuthenticated()
                  && exists(/databases/$(database)/documents/users/$(request.auth.uid)/resumes/$(resumeId));

      allow create: if isAuthenticated()
                    && exists(/databases/$(database)/documents/users/$(request.auth.uid)/resumes/$(resumeId))
                    && request.resource.data.createdBy == request.auth.uid;

      allow update, delete: if isAuthenticated()
                            && exists(/databases/$(database)/documents/users/$(request.auth.uid)/resumes/$(resumeId))
                            && resource.data.createdBy == request.auth.uid;
    }

    // ========== DEFAULT DENY ==========
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
